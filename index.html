<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard IoT ‚Äî RFID & Empreinte</title>

    <!-- Police -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- Ton CSS externe -->
    <link rel="stylesheet" href="style.css">

    <!-- MQTT -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>

<div class="container">

    <!-- ========================= HEADER ========================= -->
    <header class="app-header">
        <div class="brand">
            <div class="logo">üîê</div>
            <div class="titles">
                <h1>Dashboard IoT</h1>
                <p class="subtitle">ESP32 ¬∑ Authentification RFID & Empreinte</p>
            </div>
        </div>

        <div class="header-right">
            <div id="mqtt-status" class="conn-value offline">MQTT : D√©connect√©</div>
            <div id="last-update" class="last-update">MAJ : --:--:--</div>
            <button id="btn-toggle-config" class="btn btn-ghost">‚öôÔ∏è</button>
        </div>
    </header>

    <!-- ======================== PANNEAU CONFIG ======================== -->
    <section id="config-panel" class="config-box">
        <h4>Configuration Broker MQTT</h4>

        <div class="config-grid-compact">
            <div class="cfg-row">
                <label>H√¥te</label>
                <input id="cfg-host" value="broker.emqx.io">
            </div>

            <div class="cfg-row">
                <label>Port</label>
                <input id="cfg-port" value="8083">
            </div>

            <div class="cfg-row">
                <label>Path</label>
                <input id="cfg-path" value="/mqtt">
            </div>

            <div class="cfg-row">
                <label>ClientId</label>
                <input id="cfg-clientid">
            </div>

            <div class="cfg-row wide">
                <label>Topic √† souscrire</label>
                <input id="cfg-topic-sub" value="auth/door/#">
            </div>
        </div>

        <div class="config-actions">
            <button id="btnConnect" class="btn btn-primary">Reconnecter</button>
            <button id="btnDisconnect" class="btn btn-danger">D√©connecter</button>
        </div>
    </section>

    <div class="spacer"></div>

    <!-- =========================== APPAIRAGE =========================== -->
    <section class="pairing-section">
        <div class="pair-card combined-card">

            <div id="pair-badge" class="pair-badge unpaired">
                NON<br>APPAIR√â
            </div>

            <div class="pair-details combined-details">

                <div class="pair-actions-row">
                    <button id="btn-pair" class="btn btn-primary small">Demander l‚Äôappairage</button>
                    <button id="btn-unpair" class="btn btn-secondary small" style="display:none;">Dissocier</button>
                    <button id="btn-reconnect" class="btn btn-ghost small">Reconnecter</button>
                </div>

                <div class="pair-main spaced">
                    Statut : <strong id="pair-main-value">Non appair√©</strong>
                </div>

                <div id="pair-challenge" class="pair-challenge muted" style="display:none;">
                    Code affich√© sur l'ESP32
                </div>

            </div>

            <div class="card-input pairing-input">
                <label for="pair-code">Code affich√© sur l‚ÄôESP32</label>
                <div class="code-row">
                    <input id="pair-code" type="text">
                    <button id="btn-confirm-pair" class="btn btn-success small">Valider</button>
                </div>
            </div>

        </div>
    </section>

    <!-- ====================== GRILLE PRINCIPALE ======================= -->
    <main class="dashboard-grid">

        <!-- LOG D'√âV√âNEMENTS -->
        <article class="card full-width">

            <div class="card-top">
                <h3>üì± √âV√âNEMENTS D'ACC√àS</h3>
                <div class="chip">Topic : auth/door/event</div>
            </div>

            <div class="esp32-messages">
                <div class="message-header">
                    <span>M√©thode</span>
                    <span>Utilisateur / Cl√©</span>
                    <span>R√©sultat</span>
                    <span>Heure</span>
                </div>

                <div id="esp32-message-log" class="message-log esp32-log"></div>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <span>Acc√®s RFID</span>
                    <span id="rfid-count" class="stat-value">0</span>
                </div>

                <div class="stat-item">
                    <span>Acc√®s Empreinte</span>
                    <span id="fingerprint-count" class="stat-value">0</span>
                </div>

                <div class="stat-item">
                    <span>Refus√©s</span>
                    <span id="denied-count" class="stat-value refused">0</span>
                </div>
            </div>

        </article>

        <!-- DERNIER RFID -->
        <section class="card">
            <h3>üì° DERNIER RFID</h3>

            <div class="status-container">
                <div id="rfid-status" class="device-status waiting">
                    <div id="rfid-val">En attente...</div>
                    <div id="rfid-time">--:--:--</div>
                </div>

                <div class="history">
                    <h4>Historique RFID</h4>
                    <div id="rfid-history" class="history-list"></div>
                </div>
            </div>
        </section>

        <!-- DERNI√àRE EMPREINTE -->
        <section class="card">
            <h3>üëÜ DERNI√àRE EMPREINTE</h3>

            <div class="status-container">
                <div id="fingerprint-status" class="device-status waiting">
                    <div id="fp-val">En attente...</div>
                    <div id="fp-time">--:--:--</div>
                </div>

                <div class="history">
                    <h4>Historique Empreintes</h4>
                    <div id="fingerprint-history" class="history-list"></div>
                </div>
            </div>
        </section>

        <!-- COMMANDES -->
        <section class="card commands">
            <h3>‚öôÔ∏è COMMANDES (auth/door/command)</h3>

            <div class="button-grid">
                <button class="btn btn-primary" id="btn-open">üîì OUVRIR PORTE</button>
                <button class="btn btn-info" id="btn-list">üìã LISTER USERS</button>
                <button class="btn btn-danger" id="btn-clear">üóëÔ∏è SUPPRIMER TOUT</button>
                <button class="btn btn-secondary" id="btn-clear-logs">üßπ Vider Logs</button>
            </div>

            <div class="custom-command">
                <h4>Log Brut (Debug)</h4>
                <div id="raw-log" class="raw-log">En attente de donn√©es...</div>
            </div>

        </section>

    </main>

</div>

<!-- ============================ JAVASCRIPT ============================ -->
<script>

    let client = null;
    let counts = { rfid: 0, fp: 0, denied: 0 };

    const TOPIC_PAIR = "auth/door/pair";
    const TOPIC_PAIR_STATUS = "auth/door/pair_status";
    const TOPIC_COMMAND = "auth/door/command";

    /* =====================================================================
        DOM READY
    ===================================================================== */

    document.addEventListener("DOMContentLoaded", () => {

        document.getElementById("btn-toggle-config").onclick = toggleConfig;

        document.getElementById("btnConnect").onclick = connectMQTT;
        document.getElementById("btnDisconnect").onclick = disconnectMQTT;

        document.getElementById("btn-pair").onclick = pairRequest;
        document.getElementById("btn-confirm-pair").onclick = confirmPair;
        document.getElementById("btn-unpair").onclick = unpair;
        document.getElementById("btn-reconnect").onclick = connectMQTT;

        document.getElementById("btn-open").onclick = () => sendCommand("OPEN");
        document.getElementById("btn-list").onclick = () => sendCommand("LIST");

        document.getElementById("btn-clear").onclick = confirmClear;

        document.getElementById("btn-clear-logs").onclick = () => {
            document.getElementById("esp32-message-log").innerHTML = "";
            document.getElementById("raw-log").innerHTML = "";
        };

        const stored = localStorage.getItem("clientId");
        if (stored) { document.getElementById("cfg-clientid").value = stored; }

        updatePairIndicator();
        connectMQTT();
    });

    /* =====================================================================
        CONFIG PANEL
    ===================================================================== */

    function toggleConfig() {
        document.getElementById("config-panel").classList.toggle("visible");
    }

    /* =====================================================================
        MQTT CONNECTION
    ===================================================================== */

    function ensureClientIdProvided() {
        let cid = document.getElementById("cfg-clientid").value.trim();
        if (!cid) {
            cid = "web_" + Math.random().toString(16).substring(2, 8);
            document.getElementById("cfg-clientid").value = cid;
            localStorage.setItem("clientId", cid);
        }
        return cid;
    }

    function connectMQTT() {

        const host = document.getElementById("cfg-host").value.trim();
        const port = document.getElementById("cfg-port").value.trim();
        const path = document.getElementById("cfg-path").value.trim();
        const topicSub = document.getElementById("cfg-topic-sub").value.trim();

        const clientId = ensureClientIdProvided();

        if (!host || !port) {
            alert("H√¥te + Port obligatoires");
            return;
        }

        if (client) {
            try { client.end(true); } catch (e) {}
        }

        const url = `ws://${host}:${port}${path}`;

        client = mqtt.connect(url, {
            clientId: clientId,
            clean: true
        });

        client.on("connect", () => {
            updateStatus(true);
            if (topicSub) {
                client.subscribe(topicSub);
            }
            client.subscribe(TOPIC_PAIR_STATUS);
        });

        client.on("message", (topic, msg) => {
            handleMessage(topic, msg.toString());
        });

        client.on("close", () => {
            updateStatus(false);
        });
    }

    function disconnectMQTT() {
        if (client) {
            try { client.end(true); } catch (e) {}
        }
        client = null;
        updateStatus(false);
    }

    function updateStatus(ok) {
        const el = document.getElementById("mqtt-status");
        el.textContent = ok ? "MQTT : Connect√©" : "MQTT : D√©connect√©";
        el.className = ok ? "conn-value online" : "conn-value offline";

        document.getElementById("last-update").textContent =
            "MAJ : " + new Date().toLocaleTimeString();

        updatePairIndicator();
    }

    /* =====================================================================
        PAIRING LOGIC
    ===================================================================== */

    function pairRequest() {
        const cid = ensureClientIdProvided();
        client.publish(TOPIC_PAIR, "REQ:" + cid);
    }

    function confirmPair() {
        const cid = ensureClientIdProvided();
        const code = document.getElementById("pair-code").value;
        client.publish(TOPIC_PAIR, "CONF:" + cid + ":" + code);
    }

    function unpair() {
        const cid = ensureClientIdProvided();
        client.publish(TOPIC_PAIR, "UNP:" + cid);
    }

    function updatePairIndicator() {
        const cid = ensureClientIdProvided();
        const paired = localStorage.getItem("paired_client") === cid;

        const badge = document.getElementById("pair-badge");
        const main = document.getElementById("pair-main-value");

        if (paired) {
            badge.className = "pair-badge paired";
            badge.innerHTML = "APPAIR√â";
            main.textContent = "Appair√© ‚Ä¢ " + cid;
            document.getElementById("btn-pair").style.display = "none";
            document.getElementById("btn-unpair").style.display = "inline-block";
        } else {
            badge.className = "pair-badge unpaired";
            badge.innerHTML = "NON<br>APPAIR√â";
            main.textContent = "Non appair√©";
            document.getElementById("btn-pair").style.display = "inline-block";
            document.getElementById("btn-unpair").style.display = "none";
        }
    }

    function handlePairStatusMessage(msg) {
        if (msg.startsWith("PAIR_OK:")) {
            const cid = msg.substring(8);
            localStorage.setItem("paired_client", cid);
            updatePairIndicator();
        }

        if (msg.startsWith("CHALLENGE:")) {
            const el = document.getElementById("pair-challenge");
            el.style.display = "block";
            setTimeout(() => { el.style.display = "none"; }, 3000);
        }
    }

    /* =====================================================================
        EVENT HANDLING
    ===================================================================== */

    function handleMessage(topic, payload) {

        const log = document.getElementById("raw-log");
        log.innerHTML =
            `<div class="raw-line">[${new Date().toLocaleTimeString()}] ${topic} : ${payload}</div>`
            + log.innerHTML;

        if (topic === TOPIC_PAIR_STATUS) {
            handlePairStatusMessage(payload);
            return;
        }

        if (topic.includes("status")) {
            return;
        }

        let data = null;

        try {
            data = JSON.parse(payload);
        } catch (e) {
            addLogEntry("INFO", topic, payload, new Date().toLocaleTimeString());
            return;
        }

        if (data.cmd === "list") {
            alert("Liste re√ßue : " + data.count);
            return;
        }

        const method = data.method;
        const name = data.name || "Inconnu";
        const result = data.result;
        const ts = new Date().toLocaleTimeString();

        if (result === "denied") {
            counts.denied++;
            document.getElementById("denied-count").textContent = counts.denied;
        }

        if (method === "rfid") {
            counts.rfid++;
            document.getElementById("rfid-count").textContent = counts.rfid;
            updateDeviceCard("rfid", name, result, ts);
        }

        if (method === "finger") {
            counts.fp++;
            document.getElementById("fingerprint-count").textContent = counts.fp;
            updateDeviceCard("fingerprint", name, result, ts);
        }

        addLogEntry(method, name, result, ts);
    }

    /* =====================================================================
        UPDATE DEVICE CARDS
    ===================================================================== */

    function updateDeviceCard(type, name, result, time) {

        const statusEl = document.getElementById(type + "-status");
        const valEl =
            document.getElementById(type === "rfid" ? "rfid-val" : "fp-val");
        const timeEl =
            document.getElementById(type === "rfid" ? "rfid-time" : "fp-time");

        const historyEl = document.getElementById(type + "-history");

        statusEl.className = "device-status " + result;
        valEl.textContent = name;
        timeEl.textContent = time;

        setTimeout(() => {
            statusEl.className = "device-status waiting";
        }, 2500);

        const item = document.createElement("div");
        item.className = "history-item";
        item.innerHTML = `<strong>${time}</strong> - ${name} (${result})`;

        historyEl.prepend(item);

        if (historyEl.children.length > 5) {
            historyEl.lastChild.remove();
        }
    }

    /* =====================================================================
        LOG TABLE
    ===================================================================== */

    function addLogEntry(method, user, result, time) {
        const log = document.getElementById("esp32-message-log");

        const row = document.createElement("div");
        row.className = "message-grid";

        const cls =
            result === "granted" || result === "ok"
                ? "res-granted"
                : result === "denied"
                ? "res-denied"
                : "res-other";

        row.innerHTML = `
            <div>${(method || "INFO").toUpperCase()}</div>
            <div>${user}</div>
            <div class="${cls}">${(result || "").toUpperCase()}</div>
            <div>${time}</div>
        `;

        log.prepend(row);

        if (log.children.length > 500) {
            log.lastChild.remove();
        }
    }

    /* =====================================================================
        COMMANDS MQTT
    ===================================================================== */

    function sendCommand(cmd) {
        if (!client || !client.connected) {
            alert("MQTT d√©connect√©");
            return;
        }

        // 1. R√©cup√®re l'ID client qui est n√©cessaire pour l'autorisation c√¥t√© ESP32.
        const clientId = ensureClientIdProvided();

        // 2. Construit le message dans le format attendu par l'ESP32: CMD:<clientId>:<COMMAND>
        const payload = "CMD:" + clientId + ":" + cmd;

        // 3. Publie le message
        client.publish(TOPIC_COMMAND, payload);
    
        // Ajoutez un log pour le debug
        console.log(`Commande MQTT envoy√©e: ${TOPIC_COMMAND} -> ${payload}`);
    }

    function confirmClear() {
        if (!confirm("Supprimer tous les utilisateurs ?")) { return; }
        sendCommand("CLEAR_ALL");
    }

</script>

</body>
</html>
