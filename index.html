<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Dashboard IoT ‚Äî RFID & Empreinte</title>

	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="style.css">
	<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
	<div class="container">
		<header class="app-header">
			<div class="brand">
				<div class="logo">üîê</div>
				<div class="titles">
					<h1>Dashboard IoT</h1>
					<p class="subtitle">ESP32 ¬∑ Authentification RFID & Empreinte</p>
				</div>
			</div>

			<div class="header-right">
				<div id="mqtt-status" class="conn-value offline">MQTT : D√©connect√©</div>
				<div id="last-update" class="last-update">MAJ : --:--:--</div>
				<button id="btn-toggle-config" class="btn btn-ghost">‚öôÔ∏è</button>
			</div>
		</header>

		<section id="config-panel" class="config-box">
			<h4>Configuration Broker MQTT</h4>

			<div class="config-grid-compact">
				<div class="cfg-row">
					<label for="cfg-host">H√¥te</label>
					<input id="cfg-host" type="text" value="broker.emqx.io" placeholder="H√¥te">
				</div>

				<div class="cfg-row">
					<label for="cfg-port">Port</label>
					<input id="cfg-port" type="text" value="8083" placeholder="Port (WebSocket)">
				</div>

				<div class="cfg-row">
					<label for="cfg-path">Path</label>
					<input id="cfg-path" type="text" value="/mqtt" placeholder="Path (ex : /mqtt)">
				</div>

				<div class="cfg-row">
					<label for="cfg-clientid">ClientId</label>
					<input id="cfg-clientid" type="text" placeholder="ClientId (optionnel)">
				</div>

				<div class="cfg-row wide">
					<label for="cfg-topic-sub">Topic √† souscrire</label>
					<input id="cfg-topic-sub" type="text" value="auth/door/#" placeholder="Topic Sub">
				</div>
			</div>

			<div class="config-actions">
				<button id="btnConnect" class="btn btn-primary">Reconnecter</button>
				<button id="btnDisconnect" class="btn btn-danger">D√©connecter</button>
			</div>
		</section>

		<div class="spacer"></div>

		<!-- SINGLE pairing card (fusion badge + actions + input) -->
		<section class="pairing-section">
			<div class="pair-card combined-card">
				<!-- left: badge -->
				<div id="pair-badge" class="pair-badge unpaired" aria-hidden="true">NON<br>APPAIR√â</div>

				<!-- center: details & actions (flexible, can shrink) -->
				<div class="pair-details combined-details">
					<div class="pair-actions-row">
						<button id="btn-pair" class="btn btn-primary small">Demander l‚Äôappairage</button>
						<button id="btn-unpair" class="btn btn-secondary small" style="display:none;">Dissocier</button>
						<button id="btn-reconnect" class="btn btn-ghost small">Reconnecter</button>
					</div>

					<div class="pair-main spaced">Statut : <strong id="pair-main-value">Non appair√©</strong></div>

					<!-- challenge hint text (kept small & spaced) -->
					<div id="pair-challenge" class="pair-challenge muted" style="display:none;">Code affich√© sur l'ESP32</div>
				</div>

				<!-- right: input (fixed-ish but allowed to shrink on small screens) -->
				<div class="card-input pairing-input">
					<label for="pair-code">Code affich√© sur l‚ÄôESP32</label>
					<div class="code-row">
						<input id="pair-code" type="text" placeholder="Entrer le code">
						<button id="btn-confirm-pair" class="btn btn-success small">Valider</button>
					</div>
				</div>
			</div>
		</section>

		<main class="dashboard-grid">
			<article class="card full-width">
				<div class="card-top">
					<h3>üì± √âV√âNEMENTS D'ACC√àS</h3>
					<div class="chip">Topic : auth/door/event</div>
				</div>

				<div class="section-description">
					<p>Journal des tentatives d'acc√®s ‚Äî affichage √©pur√© et tri√©, dernier en haut.</p>
				</div>

				<div class="esp32-messages">
					<div class="message-header">
						<span>M√©thode</span>
						<span>Utilisateur / Cl√©</span>
						<span>R√©sultat</span>
						<span>Heure</span>
					</div>
					<div id="esp32-message-log" class="message-log esp32-log" aria-live="polite"></div>
				</div>

				<div class="stats">
					<div class="stat-item">
						<span class="stat-label">Acc√®s RFID</span>
						<span id="rfid-count" class="stat-value stat-success">0</span>
					</div>
					<div class="stat-item">
						<span class="stat-label">Acc√®s Empreinte</span>
						<span id="fingerprint-count" class="stat-value stat-success">0</span>
					</div>
					<div class="stat-item">
						<span class="stat-label">Refus√©s</span>
						<span id="denied-count" class="stat-value refused">0</span>
					</div>
				</div>
			</article>

			<section class="card">
				<h3>üì° DERNIER RFID</h3>
				<div class="status-container">
					<div id="rfid-status" class="device-status waiting">
						<div class="value" id="rfid-val">En attente...</div>
						<div class="time" id="rfid-time">--:--:--</div>
					</div>
					<div class="history">
						<h4>Historique RFID</h4>
						<div id="rfid-history" class="history-list"></div>
					</div>
				</div>
			</section>

			<section class="card">
				<h3>üëÜ DERNI√àRE EMPREINTE</h3>
				<div class="status-container">
					<div id="fingerprint-status" class="device-status waiting">
						<div class="value" id="fp-val">En attente...</div>
						<div class="time" id="fp-time">--:--:--</div>
					</div>
					<div class="history">
						<h4>Historique Empreintes</h4>
						<div id="fingerprint-history" class="history-list"></div>
					</div>
				</div>
			</section>

			<!-- COMMANDS card: buttons first, then raw-log (below buttons) -->
			<section class="card commands">
				<h3>‚öôÔ∏è COMMANDES (auth/door/command)</h3>

				<!-- buttons -->
				<div class="button-grid">
					<button id="btn-open" class="btn btn-primary">üîì OUVRIR PORTE</button>
					<button id="btn-list" class="btn btn-info">üìã LISTER USERS</button>
					<button id="btn-clear" class="btn btn-danger">üóëÔ∏è SUPPRIMER TOUT</button>
					<button id="btn-clear-logs" class="btn btn-secondary">üßπ Vider Logs</button>
				</div>

				<!-- raw log BELOW the buttons -->
				<div class="custom-command">
					<h4>Log Brut (Debug)</h4>
					<div id="raw-log" class="raw-log">En attente de donn√©es...</div>
				</div>
			</section>
		</main>
	</div>

	<script>
		/* ========== App logic with improved log coloring & UI adjustments ========== */

		let client = null;
		let counts = { rfid: 0, fp: 0, denied: 0 };
		const TOPIC_PAIR = "auth/door/pair";
		const TOPIC_PAIR_STATUS = "auth/door/pair_status";
		const TOPIC_COMMAND = "auth/door/command";

		document.addEventListener("DOMContentLoaded", () => {
			document.getElementById("btn-toggle-config").addEventListener("click", toggleConfig);
			document.getElementById("btnConnect").addEventListener("click", connectMQTT);
			document.getElementById("btnDisconnect").addEventListener("click", disconnectMQTT);
			document.getElementById("btn-pair").addEventListener("click", pairRequest);
			document.getElementById("btn-confirm-pair").addEventListener("click", confirmPair);
			document.getElementById("btn-unpair").addEventListener("click", unpair);
			document.getElementById("btn-reconnect").addEventListener("click", connectMQTT);
			document.getElementById("btn-open").addEventListener("click", () => sendCommand("OPEN"));
			document.getElementById("btn-list").addEventListener("click", () => sendCommand("LIST"));
			document.getElementById("btn-clear").addEventListener("click", confirmClear);
			document.getElementById("btn-clear-logs").addEventListener("click", () => { document.getElementById("esp32-message-log").innerHTML = ""; document.getElementById("raw-log").innerHTML = ""; });
			const stored = localStorage.getItem("clientId");
			if (stored) document.getElementById("cfg-clientid").value = stored;
			updatePairIndicator();
			connectMQTT();
		});

		function toggleConfig() { document.getElementById("config-panel").classList.toggle("visible"); }

		function ensureClientIdProvided() {
			const el = document.getElementById("cfg-clientid");
			if (!el.value) {
				const stored = localStorage.getItem("clientId");
				if (stored) el.value = stored;
				else {
					el.value = "web_" + Math.random().toString(16).substr(2, 8);
					localStorage.setItem("clientId", el.value);
				}
			} else {
				localStorage.setItem("clientId", el.value);
			}
			return el.value;
		}

		function updatePairIndicator() {
			const clientId = ensureClientIdProvided();
			const paired = localStorage.getItem("paired_client") === clientId;
			const badge = document.getElementById("pair-badge");
			const mainVal = document.getElementById("pair-main-value");
			const btnPair = document.getElementById("btn-pair");
			const btnUnpair = document.getElementById("btn-unpair");
			const challengeHint = document.getElementById("pair-challenge");
			if (paired) {
				badge.className = "pair-badge paired";
				badge.innerHTML = "APPAIR√â";
				mainVal.textContent = `Appair√© ‚Ä¢ ${clientId}`;
				btnPair.style.display = "none";
				btnUnpair.style.display = "inline-block";
				challengeHint.style.display = "none";
			} else {
				badge.className = "pair-badge unpaired";
				badge.innerHTML = "NON<br>APPAIR√â";
				mainVal.textContent = `Non appair√©`;
				btnPair.style.display = "inline-block";
				btnUnpair.style.display = "none";
				challengeHint.style.display = "none";
			}
		}

		function connectMQTT() {
			const host = document.getElementById("cfg-host").value.trim();
			const port = document.getElementById("cfg-port").value.trim();
			const path = document.getElementById("cfg-path").value.trim() || "/mqtt";
			const topicSub = document.getElementById("cfg-topic-sub").value.trim();
			const clientId = ensureClientIdProvided();
			if (!host || !port) { alert("H√¥te et port requis"); return; }
			const url = `ws://${host}:${port}${path}`;
			if (client) {
				try { client.removeAllListeners(); client.end(true); } catch(e) { console.warn(e); }
				client = null;
			}
			updateStatus(false);
			try {
				client = mqtt.connect(url, { clientId: clientId, clean: true, reconnectPeriod: 4000 });
				client.on("connect", () => {
					updateStatus(true);
					if (topicSub) client.subscribe(topicSub, () => {});
					client.subscribe(TOPIC_PAIR_STATUS, () => {});
				});
				client.on("reconnect", () => {});
				client.on("close", () => { updateStatus(false); });
				client.on("error", () => { updateStatus(false); });
				client.on("message", (topic, message) => { handleMessage(topic, message.toString()); });
			} catch (e) {
				alert("Erreur de connexion (voir console)");
			}
		}

		function disconnectMQTT() {
			if (client) {
				try { client.removeAllListeners(); client.end(true); } catch(e) { console.warn(e); }
				client = null;
				updateStatus(false);
			}
		}

		function updateStatus(connected) {
			const el = document.getElementById("mqtt-status");
			if (connected) {
				el.textContent = "MQTT : Connect√©";
				el.className = "conn-value online";
			} else {
				el.textContent = "MQTT : D√©connect√©";
				el.className = "conn-value offline";
			}
			document.getElementById("last-update").textContent = "MAJ : " + new Date().toLocaleTimeString();
			updatePairIndicator();
		}

		function pairRequest() {
			if (!client || !client.connected) { alert("MQTT d√©connect√©"); return; }
			const clientId = ensureClientIdProvided();
			client.publish(TOPIC_PAIR, `REQ:${clientId}`);
			console.info(`[PAIR] Demande d'appairage envoy√©e (${new Date().toLocaleTimeString()})`);
		}

		function confirmPair() {
			if (!client || !client.connected) { alert("MQTT d√©connect√©"); return; }
			const clientId = ensureClientIdProvided();
			const code = document.getElementById("pair-code").value.trim();
			if (!code) { alert("Entrer le code affich√© sur l'ESP32"); return; }
			client.publish(TOPIC_PAIR, `CONF:${clientId}:${code}`);
			console.info(`[PAIR] Confirmation envoy√©e (${new Date().toLocaleTimeString()})`);
		}

		function unpair() {
			if (!client || !client.connected) { alert("MQTT d√©connect√©"); return; }
			const clientId = ensureClientIdProvided();
			client.publish(TOPIC_PAIR, `UNP:${clientId}`);
			if (localStorage.getItem("paired_client") === clientId) {
				localStorage.removeItem("paired_client");
				console.info(`[PAIR] Dissociation locale (${new Date().toLocaleTimeString()})`);
				updatePairIndicator();
			}
		}

		// handle pair status messages (console + brief UI hint)
		function handlePairStatusMessage(payload) {
			if (payload.startsWith("PAIR_OK:")) {
				const cid = payload.substring(8);
				localStorage.setItem("paired_client", cid);
				console.info(`[PAIR] Appairage r√©ussi pour ${cid}`);
				updatePairIndicator();
			} else if (payload.startsWith("PAIR_FAIL:")) {
				const cid = payload.substring(10);
				console.info(`[PAIR] Appairage √©chou√© pour ${cid}`);
			} else if (payload.startsWith("CHALLENGE:")) {
				const challengeHint = document.getElementById("pair-challenge");
				challengeHint.style.display = "block";
				setTimeout(() => { challengeHint.style.display = "none"; }, 4000);
				console.info(`[PAIR] Code affich√© sur l'ESP32`);
			} else if (payload.startsWith("UNPAIR_OK:")) {
				const cid = payload.substring(10);
				if (localStorage.getItem("paired_client") === cid) localStorage.removeItem("paired_client");
				console.info(`[PAIR] Dissociation confirm√©e pour ${cid}`);
				updatePairIndicator();
			}
		}

		function handleMessage(topic, payloadStr) {
			const rawDiv = document.getElementById("raw-log");
			rawDiv.innerHTML = `<div class="raw-line">[${new Date().toLocaleTimeString()}] ${topic}: ${payloadStr}</div>` + rawDiv.innerHTML;
			if (topic === TOPIC_PAIR_STATUS) {
				handlePairStatusMessage(payloadStr);
				return;
			}
			if (topic.includes("status")) return;
			try {
				const data = JSON.parse(payloadStr);
				if (data.cmd === "list") {
					alert(`Liste re√ßue : ${data.count} utilisateurs (voir console F12)`);
					console.log("Users:", data.users);
					return;
				}
				const method = data.method;
				const result = data.result;
				const name = data.name || "Inconnu";
				const ts = new Date().toLocaleTimeString();
				if (result === "denied") {
					counts.denied++;
					const deniedEl = document.getElementById("denied-count");
					deniedEl.textContent = counts.denied;
				} else {
					if (method === "rfid") {
						counts.rfid++;
						document.getElementById("rfid-count").textContent = counts.rfid;
					} else if (method === "finger") {
						counts.fp++;
						document.getElementById("fingerprint-count").textContent = counts.fp;
					}
				}
				addLogEntry(method, name, result, ts);
			} catch (e) {
				// non-json messages become INFO
				addLogEntry("INFO", topic, payloadStr, new Date().toLocaleTimeString());
			}
		}

		function addLogEntry(method, user, result, time) {
			const logEl = document.getElementById("esp32-message-log");
			const row = document.createElement("div");
			row.className = "message-grid";

			const methodCell = document.createElement("div");
			methodCell.textContent = (method || "INFO").toString().toUpperCase();

			const userCell = document.createElement("div");
			userCell.textContent = user;

			const resultCell = document.createElement("div");
			const resText = result ? result.toString() : "";
			resultCell.textContent = resText.toUpperCase();

			const r = (resText || "").toLowerCase();
			if (r === "granted" || r === "ok" || r === "success") {
				resultCell.className = "res-granted";
			} else if (r === "denied" || r === "refused" || r === "failed") {
				resultCell.className = "res-denied";
			} else if ((method || "").toString().toUpperCase() === "INFO") {
				resultCell.className = "res-info";
			} else {
				resultCell.className = "res-other";
			}

			const timeCell = document.createElement("div");
			timeCell.textContent = time;

			row.appendChild(methodCell);
			row.appendChild(userCell);
			row.appendChild(resultCell);
			row.appendChild(timeCell);

			logEl.prepend(row);
			if (logEl.children.length > 500) logEl.lastChild.remove();
		}

		function sendCommand(cmd) {
			if (!client || !client.connected) { alert("MQTT d√©connect√©"); return; }
			client.publish(TOPIC_COMMAND, cmd);
			console.info(`[CMD] ${cmd}`);
		}

		function confirmClear() {
			if (!confirm("Confirmer suppression de tous les utilisateurs ?")) return;
			sendCommand("CLEAR_ALL");
		}
	</script>
</body>
</html>
